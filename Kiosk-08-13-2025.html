<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Volunteer Hours Tracking</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700&display=swap" rel="stylesheet">
<!-- Bootstrap 3 CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<style>
    body {
        background-color: #F5F5F5;
        font-family: 'Source Sans Pro', sans-serif;
    }
    .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #337ab7; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    /* Unified dark blue theme */
    .panel-heading, .modal-header, .nav-tabs > li.active > a, .hours-table thead th, .btn-custom {
        background-color: #112e51 !important;
        color: white !important;
    }
    .nav-tabs > li > a { background-color: #E0E0E0; font-size: 16px; font-weight: bold; }
    .nav-tabs > li.active > a { color: white; }
    .hours-table tfoot th { background-color: #112e51; color: white; }
    .btn-custom { border: none; }
    .btn-custom:hover { background-color: #0d2240 !important; }
    .form-group { margin-bottom: 25px; }
    .form-control:focus { background-color: #FFFACD; border-color: #112e51; box-shadow: 0 0 0 0.2rem rgba(17,46,81,0.25); }
    .panel-heading { display: flex; align-items: center; justify-content: space-between; border-top-left-radius: 4px; border-top-right-radius: 4px; }
    .main-title { background-color: #112e51; color: white; padding: 10px; border-top-left-radius: 4px; border-top-right-radius: 4px; margin-top: 0; margin-bottom: 0; }
    .mt-20 { margin-top: 20px; }
    .is-hidden { display: none; }
    .login-card { max-width: 400px; width: 100%; margin: 20px auto; border: 1px solid #ddd; border-radius: 8px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); overflow: hidden; }
    .login-card .content { padding: 15px; }
    .login-card .content h4 { margin-top: 6px; }
    .loading { padding: 10px; }
    /* Loading modal light theme, centered */
    .loading-modal .modal-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); margin: 0; width: 300px; max-width: 90%; }
    /* Override Bootstrap 3 fade/in transforms that can offset the dialog */
    .loading-modal.fade .modal-dialog,
    .loading-modal.in .modal-dialog { -webkit-transform: translate(-50%, -50%) !important; transform: translate(-50%, -50%) !important; }
    .loading-modal .modal-content { background-color: #eee; color: #222; border: none; border-radius: 8px; }
    .loading-modal .modal-body { text-align: center; padding: 20px; }
    .loading-modal .spinner { border: 4px solid rgba(0,0,0,0.1); border-left-color: #112e51; margin-bottom: 10px; }
    /* Session modal centered and above other modals */
    .session-modal .modal-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); margin: 0; max-width: 420px; width: 90%; }
    .session-modal.fade .modal-dialog,
    .session-modal.in .modal-dialog { -webkit-transform: translate(-50%, -50%) !important; transform: translate(-50%, -50%) !important; }
    #sessionWarningModal { z-index: 1060; }
    .modal-backdrop.session-backdrop { z-index: 1055; }
</style>
</head>
<body>

<!-- Login Section -->
<div class="container" id="loginSection">
    <div class="login-card">
        <h2 class="main-title">Volunteer Hours Tracking</h2>
        <div class="content">
        <h4>Please complete verification to log hours</h4>
        <form id="loginForm" novalidate>
        <div class="form-group">
            <label for="firstName">First Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="firstName" required pattern="[A-Za-z]+" placeholder="e.g., Jane" value="Zayan">
            <p class="text-danger error" id="firstNameError">Please enter your first name</p>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="lastName" required pattern="[A-Za-z]+" placeholder="e.g., Doe" value="Doe">
            <p class="text-danger error" id="lastNameError">Please enter your last name</p>
        </div>
        <div class="form-group">
            <label>Date of Birth <span class="text-danger">*</span></label>
            <div class="row">
                <div class="col-xs-3"><input type="text" class="form-control" id="month" placeholder="MM" required value="01"></div>
                <div class="col-xs-3"><input type="text" class="form-control" id="day" placeholder="DD" required value="01"></div>
                <div class="col-xs-4"><input type="text" class="form-control" id="year" placeholder="YYYY" required value="2000"></div>
            </div>
            <p class="text-danger error" id="monthError">Invalid month</p>
            <p class="text-danger error" id="dayError">Invalid day</p>
            <p class="text-danger error" id="yearError">Invalid year</p>
        </div>
        <div class="form-group">
            <label for="accessCode">Access Code <span class="text-danger">*</span></label>
            <input type="password" class="form-control" id="accessCode" required placeholder="e.g., 1234" value="1234">
            <p class="text-danger error" id="accessCodeError">Please enter your access code</p>
        </div>
        <div class="text-right">
            <button type="submit" class="btn btn-custom" id="loginButton" disabled>Login</button>
            <button type="reset" class="btn btn-default">Reset</button>
        </div>
        </form>
        </div>
    </div>
</div>

<!-- Welcome Section -->
<div class="container mt-20 is-hidden" id="welcomeSection">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h2 id="welcomeMessage"></h2>
            <button class="btn btn-custom" id="logoutButton">Logout</button>
        </div>
        <div class="panel-body">
            <ul class="nav nav-tabs">
                <li class="active"><a href="#timeEntry" data-toggle="tab">Time Entry</a></li>
                <li class="is-hidden" aria-hidden="true"><a href="#mealTicket" data-toggle="tab" tabindex="-1">Meal Ticket</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="timeEntry">
                    <p>Click the 'Add Hours' button to record your volunteer hours for today.</p>
                    <button class="btn btn-custom" id="addHours"><span class="glyphicon glyphicon-plus"></span> Add Hours</button>
                    <button class="btn btn-custom is-hidden" id="editHours"><span class="glyphicon glyphicon-edit"></span> Edit Hours</button>
                    <h4 id="todayHoursHeading" class="mt-20">Today's Hours</h4>
                    <table class="table table-bordered hours-table" id="hoursTable">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Volunteer Assignment</th>
                                <th>Organization</th>
                                <th>Hour Type</th>
                                <th>Approval Status</th>
                                <th>Description</th>
                                <th class="text-right">Hours</th>
                                <th class="text-right">Minutes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot id="totalHoursRow">
                            <tr>
                                <th colspan="7">Total Hours</th>
                                <th class="text-right" id="totalHours">0.00</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="tab-pane is-hidden" id="mealTicket" aria-hidden="true">
                    <p>Print your meal ticket here (placeholder).</p>
                    <button class="btn btn-custom" id="printMealTicket"><span class="glyphicon glyphicon-print"></span> Print Meal Ticket</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Hours Modal -->
<div class="modal fade" id="addHoursModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">Add Volunteer Hours</h4>
            </div>
            <div class="modal-body">
                <form id="addHoursForm">
                    <div class="form-group">
                        <label for="volunteerAssignment">Volunteer Assignment <span class="text-danger">*</span></label>
                        <select class="form-control" id="volunteerAssignment" required>
                            <option value="" disabled selected>Select an assignment</option>
                            <option value="Event Support">Event Support</option>
                            <option value="Admin Support">Admin Support</option>
                            <option value="Community Outreach">Community Outreach</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="organization">Organization <span class="text-danger">*</span></label>
                        <select class="form-control" id="organization" required>
                            <option value="" disabled selected>Select an organization</option>
                            <option value="Red Cross">Red Cross</option>
                            <option value="Local Shelter">Local Shelter</option>
                            <option value="Food Bank">Food Bank</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hourType">Hour Type <span class="text-danger">*</span></label>
                        <select class="form-control" id="hourType" required>
                            <option value="" disabled selected>Select hour type</option>
                            <option value="Regular Time">Regular Time</option>
                            <option value="Extra Time">Extra Time</option>
                            <option value="Heavy Duty">Heavy Duty</option>
                            <option value="Approved Time">Approved Time</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-6">
                                <label for="hours">Hours <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="hours" min="0" max="23" required>
                            </div>
                            <div class="col-xs-6">
                                <label for="minutes">Minutes <span class="text-danger">*</span></label>
                                <select class="form-control" id="minutes" required>
                                    <option value="" disabled selected>Select minutes</option>
                                    <option value="0">0</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="Enter any additional details (optional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="resetHoursForm">Reset</button>
                <button type="button" class="btn btn-custom" id="saveHours" disabled>Save</button>
                <button type="button" class="btn btn-custom is-hidden" id="updateHours">Update</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Session Timeout Warning Modal -->
<div class="modal fade session-modal" id="sessionWarningModal" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Session Timeout</h4>
            </div>
            <div class="modal-body">
                <p>Your session will expire in 20 seconds.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="signoutSession">Sign out</button>
                <button type="button" class="btn btn-custom" id="extendSession">Extend</button>
            </div>
        </div>
    </div>
    </div>

<!-- Loading Modal -->
<div class="modal fade loading-modal" id="loadingModal" tabindex="-1" data-backdrop="static" data-keyboard="false" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body">
                <div class="spinner"></div>
                <div id="loadingModalText">Loading...</div>
            </div>
        </div>
    </div>
    </div>

<script>
$(function(){
    $('.error').hide();

    // Session management
    const SESSION_DURATION_MS = 300000; // 5 minutes
    const SESSION_WARNING_OFFSET_MS = 20000; // warn 20s before expiry
    let sessionWarningTimeoutId = null;
    let sessionExpireTimeoutId = null;

    function clearSessionTimers(){
        if(sessionWarningTimeoutId){ clearTimeout(sessionWarningTimeoutId); sessionWarningTimeoutId = null; }
        if(sessionExpireTimeoutId){ clearTimeout(sessionExpireTimeoutId); sessionExpireTimeoutId = null; }
    }

    function scheduleSessionTimers(remainingMs = SESSION_DURATION_MS){
        clearSessionTimers();
        if (remainingMs <= 0) { handleSessionExpired(); return; }
        const warnDelay = Math.max(0, remainingMs - SESSION_WARNING_OFFSET_MS);
        sessionWarningTimeoutId = setTimeout(showSessionWarning, warnDelay);
        sessionExpireTimeoutId = setTimeout(handleSessionExpired, remainingMs);
    }

    function setSessionExpiryFromNow(){
        const expiryTs = Date.now() + SESSION_DURATION_MS;
        localStorage.setItem('sessionExpiry', String(expiryTs));
        return expiryTs;
    }

    function startSession(){
        const user = { firstName: $('#firstName').val().trim(), lastName: $('#lastName').val().trim() };
        localStorage.setItem('sessionUser', JSON.stringify(user));
        const expiryTs = setSessionExpiryFromNow();
        const remaining = expiryTs - Date.now();
        scheduleSessionTimers(remaining);
    }

    function showSessionWarning(){
        const expiry = parseInt(localStorage.getItem('sessionExpiry') || '0', 10);
        const remaining = Math.max(0, expiry - Date.now());
        const secs = Math.ceil(remaining / 1000);
        $('#sessionWarningModal .modal-body').html(`<p>Your session will expire in ${secs} second${secs===1?'':'s'}.</p>`);
        $('#sessionWarningModal').modal('show');
    }

    function extendSession(){
        $('#sessionWarningModal').modal('hide');
        setSessionExpiryFromNow();
        scheduleSessionTimers(SESSION_DURATION_MS);
    }

    function handleSessionExpired(){
        $('#sessionWarningModal').modal('hide');
        signoutSession();
    }

    function signoutSession(){
        clearSessionTimers();
        // Ensure the timeout modal is closed
        $('#sessionWarningModal').modal('hide');
    $('#loadingModal').modal('hide');
        localStorage.removeItem('sessionExpiry');
        localStorage.removeItem('sessionUser');
        $('#welcomeSection').hide();
        $('#loginSection').show();
    }

    function restoreSessionIfActive(){
        const expiry = parseInt(localStorage.getItem('sessionExpiry') || '0', 10);
        if (expiry > Date.now()){
            const userRaw = localStorage.getItem('sessionUser');
            let user = { firstName: '', lastName: '' };
            if (userRaw){
                try { user = JSON.parse(userRaw) || user; } catch(e) { /* ignore */ }
            }
            $('#loginSection').hide();
            $('#welcomeMessage').text(`Welcome ${user.firstName} ${user.lastName}`);
            $('#welcomeSection').show();
            loadHoursTable();
            const remaining = expiry - Date.now();
            scheduleSessionTimers(remaining);
        }
    }

    $('#extendSession').on('click', extendSession);
    $('#signoutSession').on('click', signoutSession);
    // Ensure the session modal backdrop sits above other modals
    $('#sessionWarningModal').on('shown.bs.modal', function(){
        $('.modal-backdrop').last().addClass('session-backdrop');
    });

    function validateLogin(){
        const valid = $('#firstName').val().trim() && $('#lastName').val().trim() && $('#month').val() && $('#day').val() && $('#year').val() && $('#accessCode').val();
        $('#loginButton').prop('disabled', !valid);
    }
    $('#loginForm input').on('input', validateLogin);
    // Try to restore session across refresh
    restoreSessionIfActive();
    // Ensure initial state reflects any prefilled values
    validateLogin();

    $('#loginForm').submit(function(e){
        e.preventDefault();
        // Show loading dialog for 3 seconds before proceeding
        $('#loadingModalText').text('Loading...');
        $('#loadingModal').modal('show');
        setTimeout(function(){
            $('#loadingModal').modal('hide');
            $('#loginSection').hide();
            $('#welcomeMessage').text(`Welcome ${$('#firstName').val()} ${$('#lastName').val()}`);
            $('#welcomeSection').show();
            loadHoursTable();
            startSession();
        }, 3000);
    });

    $('#logoutButton').click(function(){
        signoutSession();
    });

    function loadHoursTable(){
        const stored = JSON.parse(localStorage.getItem('volunteerHours')) || [];
        const tbody = $('#hoursTable tbody').empty();
        let total = 0;
        stored.forEach((row, idx)=>{
            total += parseInt(row.hours) + parseInt(row.minutes)/60;
            const safeDesc = row.description ? row.description.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
            const disabledAttr = row.approvalStatus === 'Approved' ? 'disabled data-toggle="tooltip" title="Approved time cannot be updated."' : '';
            tbody.append(`<tr data-index="${idx}">
                <td class="text-center"><input type="checkbox" class="hour-select" value="${idx}" ${disabledAttr}></td>
                <td>${row.volunteerAssignment}</td>
                <td>${row.organization}</td>
        <td>${row.hourType || ''}</td>
                <td>${row.approvalStatus || 'Pending'}</td>
                <td>${safeDesc}</td>
                <td class="text-right">${row.hours}</td>
                <td class="text-right">${row.minutes}</td>
            </tr>`);
        });
        $('#totalHours').text(total.toFixed(2));

        // Initialize tooltips for any disabled checkboxes
        $('[data-toggle="tooltip"]').tooltip({ container: 'body' });

        // Reset selection UI
        $('#editHours').addClass('is-hidden');
        $('#addHours').removeClass('is-hidden');
        $('.hour-select').off('change').on('change', function(){
            if ($(this).is(':checked')){
                // enforce single selection
                $('.hour-select').not(this).prop('checked', false);
                $('#addHours').addClass('is-hidden');
                $('#editHours').removeClass('is-hidden');
                // Reset session on user activity (selection)
                extendSession();
            } else {
                if ($('.hour-select:checked').length === 0){
                    $('#editHours').addClass('is-hidden');
                    $('#addHours').removeClass('is-hidden');
                }
            }
        });

        // Clicking anywhere on a row selects it and resets session
        $('#hoursTable tbody').off('click.rowselect').on('click.rowselect','tr', function(e){
            // If the direct click was on a checkbox, let the change handler handle it
            if ($(e.target).is('input.hour-select')) return;
            const cb = $(this).find('input.hour-select');
            if (cb.length){
                if (cb.prop('disabled')){
                    // Briefly show tooltip to explain why it's disabled
                    cb.tooltip('show');
                    setTimeout(function(){ cb.tooltip('hide'); }, 1500);
                    return;
                }
                cb.prop('checked', true).trigger('change');
                // Reset session on row click
                extendSession();
            }
        });
    }

    function validateAddHours(){
        const valid = $('#volunteerAssignment').val() && $('#organization').val() && $('#hourType').val() && $('#hours').val() !== "" && $('#minutes').val() !== "";
        $('#saveHours').prop('disabled', !valid);
    }
    $('#addHoursForm select, #addHoursForm input').on('input change', validateAddHours);

    $('#addHours').click(function(){
        // Reset session on user activity
        extendSession();
        $('#addHoursForm')[0].reset();
        $('#saveHours').prop('disabled', true);
        $('#updateHours').addClass('is-hidden');
        $('#saveHours').removeClass('is-hidden');
    $('#resetHoursForm').removeClass('is-hidden');
        $('#addHoursModal .modal-title').text('Add Volunteer Hours');
    // Enable selects in add mode
    $('#volunteerAssignment, #organization').prop('disabled', false);
        $('#addHoursModal').modal('show');
    });

    $('#editHours').click(function(){
        // Reset session on user activity
        extendSession();
        const selected = $('.hour-select:checked').val();
        if (selected == null) return;
        const idx = parseInt(selected, 10);
        const stored = JSON.parse(localStorage.getItem('volunteerHours')) || [];
        const row = stored[idx];
        if (!row) return;
        // Prefill form
    $('#volunteerAssignment').val(row.volunteerAssignment);
        $('#organization').val(row.organization);
    $('#hourType').val(row.hourType || '');
        $('#hours').val(row.hours);
        $('#minutes').val(row.minutes);
        $('#description').val(row.description || '');
        // Toggle buttons
        $('#saveHours').addClass('is-hidden');
        $('#updateHours').removeClass('is-hidden').data('index', idx);
        $('#saveHours').prop('disabled', false);
    $('#resetHoursForm').addClass('is-hidden');
        $('#addHoursModal .modal-title').text('Edit Volunteer Hours');
    // Disable selects in edit mode
    $('#volunteerAssignment, #organization').prop('disabled', true);
        $('#addHoursModal').modal('show');
    });

    $('#saveHours').click(function(){
        // Reset session on user activity
        extendSession();
        // Show loading dialog for 3 seconds before saving
        $('#loadingModalText').text('Saving...');
        $('#loadingModal').modal('show');
        setTimeout(function(){
        const entry = {
            volunteerAssignment: $('#volunteerAssignment').val(),
            organization: $('#organization').val(),
            hourType: $('#hourType').val(),
            hours: parseInt($('#hours').val()),
            minutes: parseInt($('#minutes').val()),
            description: $('#description').val().trim(),
            timestamp: new Date().toISOString(),
            approvalStatus: 'Pending'
        };
        const stored = JSON.parse(localStorage.getItem('volunteerHours')) || [];
        stored.push(entry);
        localStorage.setItem('volunteerHours', JSON.stringify(stored));
        $('#addHoursModal').modal('hide');
        $('#loadingModal').modal('hide');
        loadHoursTable();
        }, 3000);
    });

    $('#updateHours').click(function(){
        // Reset session on user activity
        extendSession();
        const idx = $(this).data('index');
        if (idx == null) return;
        // Show loading dialog for 3 seconds before updating
        $('#loadingModalText').text('Updating...');
        $('#loadingModal').modal('show');
        setTimeout(function(){
            const updated = {
                volunteerAssignment: $('#volunteerAssignment').val(),
                organization: $('#organization').val(),
                hourType: $('#hourType').val(),
                hours: parseInt($('#hours').val()),
                minutes: parseInt($('#minutes').val()),
                description: $('#description').val().trim(),
                timestamp: new Date().toISOString()
            };
            const stored = JSON.parse(localStorage.getItem('volunteerHours')) || [];
            if (stored[idx]){
                // preserve existing approval status unless missing
                updated.approvalStatus = stored[idx].approvalStatus || 'Pending';
                stored[idx] = updated;
                localStorage.setItem('volunteerHours', JSON.stringify(stored));
            }
            $('#addHoursModal').modal('hide');
            $('#loadingModal').modal('hide');
            loadHoursTable();
        }, 3000);
    });

    $('#printMealTicket').click(function(){
        // Reset session on user activity
        extendSession();
        // Placeholder for print logic
    });

    $('#resetHoursForm').click(function(){
        $('#addHoursForm')[0].reset();
        $('#saveHours').prop('disabled', true);
    });
});
</script>

</body>
</html>
